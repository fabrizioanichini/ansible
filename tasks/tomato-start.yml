- name: Ensure ~/tomatoai directory exists with correct permissions
  file:
    path: "{{ lookup('env', 'HOME') }}/tomatoai"
    state: directory
    mode: '0755'
    owner: "{{ lookup('env', 'USER') }}"
    group: "{{ lookup('env', 'USER') }}"

- name: Ensure ~/tomatoai/front directory exists with correct permissions
  file:
    path: "{{ lookup('env', 'HOME') }}/tomatoai/front"
    state: directory
    mode: '0755'
    owner: "{{ lookup('env', 'USER') }}"
    group: "{{ lookup('env', 'USER') }}"

- name: Clone tomato-frontend-2.0 repository into front folder
  ansible.builtin.git:
    repo: 'git@github.com-tomatoai:tomatoai-dev/tomato-frontend-2.0.git'
    dest: "{{ lookup('env', 'HOME') }}/tomatoai/front"
    version: dev
    key_file: "{{ lookup('env', 'HOME') }}/.ssh/tomatoai_rsa"
    accept_hostkey: yes

- name: Run npm install in front folder
  command: npm install
  args:
    chdir: "{{ lookup('env', 'HOME') }}/tomatoai/front"

- name: Copy .env.example to .env in front folder
  copy:
    src: "{{ lookup('env', 'HOME') }}/tomatoai/front/.env.example"
    dest: "{{ lookup('env', 'HOME') }}/tomatoai/front/.env"
    remote_src: yes

- name: Ensure ~/tomatoai/back directory exists with correct permissions
  file:
    path: "{{ lookup('env', 'HOME') }}/tomatoai/back"
    state: directory
    mode: '0755'
    owner: "{{ lookup('env', 'USER') }}"
    group: "{{ lookup('env', 'USER') }}"

- name: Clone tomato-2.0 repository into back folder
  ansible.builtin.git:
    repo: 'git@github.com-tomatoai:tomatoai-dev/tomato-2.0.git'
    dest: "{{ lookup('env', 'HOME') }}/tomatoai/back"
    version: dev
    key_file: "{{ lookup('env', 'HOME') }}/.ssh/tomatoai_rsa"
    accept_hostkey: yes

- name: Copy backend/.env.example to backend/.env in back folder
  copy:
    src: "{{ lookup('env', 'HOME') }}/tomatoai/back/backend/.env.example"
    dest: "{{ lookup('env', 'HOME') }}/tomatoai/back/backend/.env"
    remote_src: yes

- name: Build and start Docker containers in back folder
  docker_compose:
    project_src: "{{ lookup('env', 'HOME') }}/tomatoai/back"
    state: present
    build: yes
    restarted: yes